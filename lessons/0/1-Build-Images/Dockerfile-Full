# Multi-stage build
FROM alpine:3.18 AS builder
WORKDIR /build
RUN apk add --no-cache gcc musl-dev
COPY . .
RUN gcc -o app main.c

# Final stage
FROM alpine:3.18
LABEL maintainer="your-email@example.com" \
    version="1.0" \
    description="Comprehensive Docker example"

# Set environment variables
ENV APP_HOME=/app \
    LOG_LEVEL=info

# Create non-root user
RUN addgroup -g 1000 appuser && \
    adduser -D -u 1000 -G appuser appuser

WORKDIR $APP_HOME

# Copy from builder
COPY --from=builder --chown=appuser:appuser /build/app .

# Install runtime dependencies
RUN apk add --no-cache curl bash

# Health check
HEALTHCHECK --interval=30s --timeout=5s --retries=3 \
    CMD curl -f http://localhost:8080/health || exit 1

# Expose port
EXPOSE 8080

# Volume mount point
VOLUME ["/data"]

# Switch to non-root user
USER appuser

# Default command
CMD ["./app"]

# Default arguments (can be overridden with docker run)
ENTRYPOINT ["./app"]